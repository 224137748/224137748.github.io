<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mongoose | finDream</title>
    <meta name="description" content="不积硅步，无以至千里,前端，node.js,webpack,mongodb,express">
    
    
    <link rel="preload" href="/assets/css/0.styles.9f409381.css" as="style"><link rel="preload" href="/assets/js/app.5c4360f5.js" as="script"><link rel="preload" href="/assets/js/2.3db24b65.js" as="script"><link rel="preload" href="/assets/js/20.5208477d.js" as="script"><link rel="prefetch" href="/assets/js/10.75329bda.js"><link rel="prefetch" href="/assets/js/11.cb63d4d4.js"><link rel="prefetch" href="/assets/js/12.aae2d579.js"><link rel="prefetch" href="/assets/js/13.8d418067.js"><link rel="prefetch" href="/assets/js/14.58316959.js"><link rel="prefetch" href="/assets/js/15.853f8379.js"><link rel="prefetch" href="/assets/js/16.3bad8bc0.js"><link rel="prefetch" href="/assets/js/17.b4dace30.js"><link rel="prefetch" href="/assets/js/18.ad28321a.js"><link rel="prefetch" href="/assets/js/19.4b8784a1.js"><link rel="prefetch" href="/assets/js/21.f71e3235.js"><link rel="prefetch" href="/assets/js/22.8ac97fc4.js"><link rel="prefetch" href="/assets/js/23.15c8b8c8.js"><link rel="prefetch" href="/assets/js/24.57bb3df7.js"><link rel="prefetch" href="/assets/js/25.48ed52d6.js"><link rel="prefetch" href="/assets/js/26.38f5b113.js"><link rel="prefetch" href="/assets/js/27.40056eff.js"><link rel="prefetch" href="/assets/js/28.2e4461c1.js"><link rel="prefetch" href="/assets/js/29.017219e8.js"><link rel="prefetch" href="/assets/js/3.0b1c7c8e.js"><link rel="prefetch" href="/assets/js/30.e6ba464a.js"><link rel="prefetch" href="/assets/js/31.1f27ef9f.js"><link rel="prefetch" href="/assets/js/32.fa7143d5.js"><link rel="prefetch" href="/assets/js/33.3d4940cc.js"><link rel="prefetch" href="/assets/js/34.3965a1f8.js"><link rel="prefetch" href="/assets/js/35.1dba1046.js"><link rel="prefetch" href="/assets/js/36.10c5904c.js"><link rel="prefetch" href="/assets/js/37.7f1d7c93.js"><link rel="prefetch" href="/assets/js/38.aee922c7.js"><link rel="prefetch" href="/assets/js/39.fd32f8af.js"><link rel="prefetch" href="/assets/js/4.6b23ffd7.js"><link rel="prefetch" href="/assets/js/40.9b9a6cc5.js"><link rel="prefetch" href="/assets/js/41.9b35bf8f.js"><link rel="prefetch" href="/assets/js/42.ef0b164f.js"><link rel="prefetch" href="/assets/js/43.2d5f8061.js"><link rel="prefetch" href="/assets/js/44.177ad275.js"><link rel="prefetch" href="/assets/js/45.e8bbb70e.js"><link rel="prefetch" href="/assets/js/46.fa6d8c8b.js"><link rel="prefetch" href="/assets/js/47.50bf6b5f.js"><link rel="prefetch" href="/assets/js/48.03811325.js"><link rel="prefetch" href="/assets/js/49.aaec17ee.js"><link rel="prefetch" href="/assets/js/5.3ac534ff.js"><link rel="prefetch" href="/assets/js/50.79f62a4b.js"><link rel="prefetch" href="/assets/js/51.db2a58e3.js"><link rel="prefetch" href="/assets/js/52.025cf884.js"><link rel="prefetch" href="/assets/js/53.9ddde712.js"><link rel="prefetch" href="/assets/js/54.c9c84049.js"><link rel="prefetch" href="/assets/js/55.eaaa1abc.js"><link rel="prefetch" href="/assets/js/56.2682277f.js"><link rel="prefetch" href="/assets/js/57.a6694f8f.js"><link rel="prefetch" href="/assets/js/58.8c9016b3.js"><link rel="prefetch" href="/assets/js/59.f44449fa.js"><link rel="prefetch" href="/assets/js/6.cf2c291f.js"><link rel="prefetch" href="/assets/js/60.4cdbeddc.js"><link rel="prefetch" href="/assets/js/61.27d24a67.js"><link rel="prefetch" href="/assets/js/62.d148da14.js"><link rel="prefetch" href="/assets/js/63.50cb0026.js"><link rel="prefetch" href="/assets/js/64.780f30c0.js"><link rel="prefetch" href="/assets/js/65.d9e195f2.js"><link rel="prefetch" href="/assets/js/66.a2c0bdd6.js"><link rel="prefetch" href="/assets/js/67.53df0be3.js"><link rel="prefetch" href="/assets/js/68.1d1aef80.js"><link rel="prefetch" href="/assets/js/69.93108ba8.js"><link rel="prefetch" href="/assets/js/7.dad637ab.js"><link rel="prefetch" href="/assets/js/8.be8b2b27.js"><link rel="prefetch" href="/assets/js/9.5ee82ebe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f409381.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/avatar.jpg" alt="finDream" class="logo"> <span class="site-name can-hide">finDream</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/guide/" class="nav-link">概览</a></div> <a href="https://github.com/224137748/224137748.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/guide/" class="nav-link">概览</a></div> <a href="https://github.com/224137748/224137748.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/mongodb/" class="sidebar-link">Mongodb</a></li><li><a href="/mongodb/mongodb_01_Mongodb.html" class="sidebar-link">Mongodb</a></li><li><a href="/mongodb/mongodb_02_Mongoose.html" class="active sidebar-link">Mongoose</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#定义-schema" class="sidebar-link">定义 schema</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#schematype-选项" class="sidebar-link">SchemaType 选项</a></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#实例方法" class="sidebar-link">实例方法</a></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#静态方法" class="sidebar-link">静态方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#创建一个-model" class="sidebar-link">创建一个 model</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#构造-document-实例" class="sidebar-link">构造 Document 实例</a></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#model-连接方式" class="sidebar-link">model 连接方式</a></li><li class="sidebar-sub-header"><a href="/mongodb/mongodb_02_Mongoose.html#model-方法" class="sidebar-link">model 方法</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongoose"><a href="#mongoose" class="header-anchor">#</a> Mongoose</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>如果你使用过原生<code>MongoDB</code>进行数据存储的话，你是否觉得编写<code>MongoDB</code>数据格式验证，转换和业务逻辑非常麻烦。今天学习的<code>Mongoose</code>就能为我们消除上面的烦恼，<code>Mongoose</code>为模型提供了一种直接的，基于<code>scheme</code>结构去定义你的数据模型。它内置数据验证， 查询构建，业务逻辑钩子等，开箱即用。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>使用<code>npm</code>安装<code>Mongoose</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> mongoose
</code></pre></div><h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <p>简单介绍以下使用，首先我们要在项目用引入 <code>mongoose</code> ，然后链接我们本地的 <code>test</code> 数据库。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">var</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建一个数据库连接</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb//localhost/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个Cat模型，语法mongoose.model(模型名字， Schema)</span>
<span class="token comment">// Schema 类似于模型字段类型检查的一个接口，定义模型有什么属性，以及属性的类型</span>
<span class="token comment">// 这里省略了一步，就是schema是通过 new mongoose.schema({});创建的</span>

<span class="token keyword">var</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Cat&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> String<span class="token punctuation">,</span> age<span class="token punctuation">:</span> Number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 实例化，使用 new 关键词</span>
<span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Zildjian&quot;</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 保存</span>
kitty<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;meow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">注意</p> <p>1、每个实例化的模型都具备<code>save()</code>方法。
2、mongoose 连接数据库是持续性的，并没有断开连接；</p></div> <h2 id="定义-schema"><a href="#定义-schema" class="header-anchor">#</a> 定义 schema</h2> <p><code>Mongoose</code> 的一切始于 <code>Schema</code>。每个 <code>schema</code> 都会映射到一个 <code>MongoDB collection</code> ，并定义这个<code>collection</code> 里的文档的构成。我们先来看看，如何定义一个<code>Schema</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> monggoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Schema <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">;</span>
<span class="token keyword">var</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> String<span class="token punctuation">,</span> age<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> other<span class="token punctuation">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>比如上面的例子，我想对 <code>Cat</code> 这个对象新增一个属性应该怎么实现呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在这之后你还想添加 keys 的话， 请使用 Schema.add 方法</span>
catSchema<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> color<span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其中可以定义的 <code>SchemaType</code> 有：</p> <ul><li><code>String</code></li> <li><code>Number</code></li> <li><code>Date</code></li> <li><code>Buffer</code></li> <li><code>Boolean</code></li> <li><code>Mixed</code></li> <li><code>ObjectId</code></li> <li><code>Array</code></li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>在定义 <code>schema</code>的时候，如果不加第二个参数，那么即使你在 <code>model</code>中定义了表名为<code>'user'</code>，<code>mongoose</code>会智能的在表名末尾添加一个<code>'s'</code>，那么你查询的表就会变成 <code>'users'</code>表，所以，为了安全，务必加上 <code>{collection:'table_name'}</code></p></div> <p>例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> studentSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    phone<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    score<span class="token punctuation">:</span> Array
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    collection<span class="token punctuation">:</span> <span class="token string">&quot;student&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> student <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;student&quot;</span><span class="token punctuation">,</span> studentSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="schematype-选项"><a href="#schematype-选项" class="header-anchor">#</a> SchemaType 选项</h3> <p>上面我们只是初步的介绍了怎么定义一个<code>Schema</code>，实际上 <code>Schema</code> 还有更多参数供开发者配置，类似于 <code>Vue</code> 中的 <code>props</code> 传值一样，开发者不仅可以定义属性的类型，还可以设置默认值以及其他属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> schema2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    lowercase<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 将 `test` 属性转换成小写</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">&quot;Jerry&quot;</span> <span class="token comment">// 默认值为 `Jerry`</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下面展示的属性适用于<strong>全部</strong>的 <code>SchemaType</code>:</p> <ul><li><code>required</code>: 布尔值或函数 如果值为真，为此属性添加 <code>required</code> 验证器</li> <li><code>default</code>: 任何值或函数 设置此路径默认值。如果是函数，函数返回值为默认值</li> <li><code>select</code>: 布尔值 指定 <code>query</code> 的默认 <code>projections</code></li> <li><code>validate</code>: 函数 <code>adds a validator function for this property</code></li> <li><code>get</code>: 函数 使用 <code>Object.defineProperty()</code> 定义自定义 <code>getter</code></li> <li><code>set</code>: 函数 使用 <code>Object.defineProperty()</code> 定义自定义 <code>setter</code></li> <li><code>alias</code>: 字符串 仅<code>mongoose &gt;= 4.10.0</code>。 为该字段路径定义虚拟值 <code>gets/sets</code></li></ul> <p>至于<code>索引相关</code>, <code>String</code>, <code>Number</code>, <code>Date</code>等<code>SchemaType</code>的<a href="http://www.mongoosejs.net/docs/schematypes.html" target="_blank" rel="noopener noreferrer">详情配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>可查看官网！</p> <h3 id="实例方法"><a href="#实例方法" class="header-anchor">#</a> 实例方法</h3> <p><code>documents</code> 是 <code>Models</code> 的实例。 <code>Document</code> 有很多自带的<a href="http://www.mongoosejs.net/docs/api.html#document-js" target="_blank" rel="noopener noreferrer">实例方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>， 当然开发者也可以自定义自己的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义一个Schema</span>
<span class="token keyword">var</span> animalSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> String<span class="token punctuation">,</span> type<span class="token punctuation">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在 animalSchem 的 methods 对象中声明一个 findSimilarTypes 函数</span>
animalSchema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">findSimilarTypes</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Animal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token punctuation">}</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>现在所有 <code>animal</code> 实例都有 <code>findSimilarTypes</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Animal <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Animal&quot;</span><span class="token punctuation">,</span> animalSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">&quot;dog&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// dog 实例已经可以使用 findSimilarTypes 方法</span>
dog<span class="token punctuation">.</span><span class="token function">findSimilarTypes</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> dogs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dogs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// woof</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>重写 <code>mongoose</code> 的默认方法会造成无法预料的结果，相关链接。</li> <li><strong>不要</strong>在自定义方法中<strong>使用 ES6 箭头函数</strong>，会造成 <code>this</code> 指向错误。</li></ul> <h3 id="静态方法"><a href="#静态方法" class="header-anchor">#</a> 静态方法</h3> <p>添加 <code>Model</code> 的静态方法也十分简单，继续用 <code>animalSchema</code> 举例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 给animalSchema 的 statics 对象中 声明一个 findByName 函数</span>
animalSchema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">findByName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Animal <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Animal&quot;</span><span class="token punctuation">,</span> animalSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
Animal<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span><span class="token string">&quot;fido&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> animals</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>animals<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>同样<strong>不要</strong>在静态方法中<strong>使用 ES6 箭头函数</strong>。</p> <div class="custom-block tip"><p class="custom-block-title">实例方法 和 静态方法的区别？</p> <p>实例方法中声明的函数，在实例 <code>document</code> 上调用；<br>
静态方法中声明的函数，在原型 <code>model</code> 上调用；</p></div> <h2 id="创建一个-model"><a href="#创建一个-model" class="header-anchor">#</a> 创建一个 model</h2> <p><code>Models</code> 是从 <code>Schema</code> 编译来的构造函数。 它们的实例就代表着可以从数据库保存和读取的 <code>documents</code>。 从数据库创建和读取 <code>document</code> 的所有操作都是通过 <code>model</code> 进行的。</p> <p>我们要把<code>schema</code>转换为一个<code>Model</code>， 使用<code>mongoose.model(modelName, schema)</code> 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// mongoose.model(modelName, schema)</span>
<span class="token keyword">var</span> Blog <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Blog&quot;</span><span class="token punctuation">,</span> blogSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>第一个参数是跟 <code>model</code> 对应的集合（ <code>collection</code> ）名字的 <strong><em>单数</em></strong> 形式。 <code>Mongoose</code> 会自动找到名称是 <code>model</code> 名字 <strong><em>复数</em></strong> 形式的 <code>collection</code> 。 上面篇幅也讲到这个问题，在这里<code>Tank</code> 这个 <code>model</code> 就对应数据库中 <code>tanks</code> 这个 <code>collection</code>。</p> <p><code>.model()</code> 这个函数是对 <code>schema</code> 做了拷贝（生成了 <code>model</code>）。 <strong>要确保在调用 <code>.model()</code> 之前把所有需要的东西都加进 <code>schema</code> 里了！</strong></p> <h3 id="构造-document-实例"><a href="#构造-document-实例" class="header-anchor">#</a> 构造 Document 实例</h3> <p>这里说的 <code>Documents</code> 是 <code>model</code> 的实例，实例化一个 <code>model</code>方法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> tankSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Tank <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;tank&quot;</span><span class="token punctuation">,</span> tankSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 实例化</span>
<span class="token keyword">var</span> kiki <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tank</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;kiki&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

kiki<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// saved!</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="model-连接方式"><a href="#model-连接方式" class="header-anchor">#</a> model 连接方式</h3> <p>要注意，直到<code>model</code>使用的数据库连接（ <code>connection</code> ）被打开，<code>tanks</code> 才会被创建/删除。每个 <code>model</code> 都有一个绑定的连接。 如果 <code>model</code> 是通过调用 <code>mongoose.model()</code> 生成的，它将使用 <code>mongoose</code> 的默认连接，即使用下面的连接方式（方式一）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> db <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> <span class="token string">&quot;connection error:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// we're connected!</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果自行创建了连接，就需要使用 <code>connection</code> 的 <code>model()</code> 函数连接（方式二）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost:27017/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Tank <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Tank&quot;</span><span class="token punctuation">,</span> yourSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="model-方法"><a href="#model-方法" class="header-anchor">#</a> model 方法</h3> <h4 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h4> <p>用 <code>mongoose</code> 查询文档相当容易啦，它支持 <code>MongoDB</code> 的高级（ <code>rich</code> ）查询语法。 查询文档可以用 <code>model</code> 的 <code>find</code>, <code>findById</code>, <code>findOne</code>, 和 <code>where</code> 这些静态方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>Tank<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> size<span class="token punctuation">:</span> <span class="token string">&quot;small&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;createdDate&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span>oneYearAgo<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h4> <p><code>model</code> 的 <code>remove</code> 方法可以删除所有匹配查询条件（ <code>conditions</code> ）的文档。</p> <div class="language-js extra-class"><pre class="language-js"><code>Tank<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span> size<span class="token punctuation">:</span> <span class="token string">&quot;large&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">handleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// removed!</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h4> <p><code>model</code> 的 <code>update</code> 方法可以修改数据库中的文档，<strong>不过不会把文档返回给应用层</strong>。</p> <div class="language-js extra-class"><pre class="language-js"><code>Tank<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token punctuation">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> $<span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> size<span class="token punctuation">:</span> <span class="token string">&quot;large&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果想更新单独一条文档并且返回给应用层，可以使用 <a href="http://www.mongoosejs.net/docs/api.html#model_Model.findOneAndUpdate" target="_blank" rel="noopener noreferrer">findOneAndUpdate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法。</p> <h4 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h4> <p>API 文档中包含了很多额外的方法，比如 <a href="http://www.mongoosejs.net/docs/api.html#model_Model.aggregate" target="_blank" rel="noopener noreferrer">count<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="http://www.mongoosejs.net/docs/api.html#model_Model.aggregate" target="_blank" rel="noopener noreferrer">mapReduce<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="http://www.mongoosejs.net/docs/api.html#model_Model.aggregate" target="_blank" rel="noopener noreferrer">aggregate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 还有 <a href="http://www.mongoosejs.net/docs/api.html#model_Model.aggregate" target="_blank" rel="noopener noreferrer">其他<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/224137748/224137748.github.io/edit/document/docs/mongodb/mongodb_02_Mongoose.md" target="_blank" rel="noopener noreferrer">编辑</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/8/2019, 10:12:15 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mongodb/mongodb_01_Mongodb.html" class="prev">Mongodb</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c4360f5.js" defer></script><script src="/assets/js/2.3db24b65.js" defer></script><script src="/assets/js/20.5208477d.js" defer></script>
  </body>
</html>
